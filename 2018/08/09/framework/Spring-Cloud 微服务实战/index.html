<!DOCTYPE HTML>
<html class="no-js" lang="zh-CN">
<head>
    <!--[if lte IE 9]>
<meta http-equiv="refresh" content="0;url=http://yoursite.com/warn.html">
<![endif]-->
<meta charset="utf-8">

<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
<meta http-equiv="mobile-agent" content="format=html5; url=http://yoursite.com">
<meta name="author" content="vpinfra team">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/SimpleStyle.min.css">

<link rel="shortcut icon" href="/images/favicon.png">


<title>spring-cloud 微服务实战 - vpinfra 团队博客</title>

<meta name="keywords" content="">

<meta name="description " content="">
</head>
<body>
<div id="nav">
    <nav class="nav-menu">
        <a class="site-name current" href="/" title="INFRA">INFRA</a>
        <a class="site-index current" href="/"><i class="fa fa-home"></i><span>首页</span></a>
        <a href="/archives" title="归档"><i class="fa fa-archives"></i><span>归档</span></a>
        <a href="/tags" title="标签"><i class="fa fa-tags"></i><span>标签</span></a>
        <!-- custom single page of menus -->
        
        
        <a href="/help" title="帮助">
            <i class="fa fa-question-circle"></i>
            <span>帮助</span>
        </a>
        
    </nav>
</div>

<div class="nav-user">
    <a class="btn-search" href="#"><i class="fa fa-search"></i></a>
    <a class="btn-read-mode" href="#"><i class="fa fa-sun-o"></i></a>
    <a class="btn-sns-qr" href="javascript:"><i class="fa fa-telegram"></i></a>
</div>

<div id="wrapper" class="clearfix">
    <div id="body">
        <div class="main" id="main">
            <div id="cover">
    <div class="cover-img"></div>
    <div class="cover-info">
        
        <h1 class="cover-siteName">INFRA</h1>
        <h3 class="cover-siteTitle">做产品，写代码</h3>
        <p class="cover-siteDesc">高效，开放，工匠精神</p>
        <div class="cover-sns">
            
            <div class="btn btn-github">
                <a href="https://github.com/vpinfra" target="_blank" title="github" ref="friend">
                    <i class="fa fa-github"></i>
                </a>
            </div>
            
        </div>
    </div>
</div>
            <div class="page-title">
    <ul>
        <li><a href="/">最新</a></li>
        
            
                <li class="">
                    <a href="/categories/前端" data-name="前端">前端</a>
                </li>
            
                <li class="active">
                    <a href="/categories/后端" data-name="后端">后端</a>
                </li>
            
                <li class="">
                    <a href="/categories/运维" data-name="运维">运维</a>
                </li>
            
                <li class="">
                    <a href="/categories/大数据" data-name="BI">BI</a>
                </li>
            
                <li class="">
                    <a href="/categories/源码系列" data-name="源码系列">源码系列</a>
                </li>
            
        
        <li class="page-search">
    <form id="search" class="search-form">
        <label for="s" class="sr-only">请输入关键字</label>
        <input class="search-field" type="text" name="s" class="text" placeholder="请输入关键字" />
        <button type="submit" class="search-form-submit" title="搜索"><i class="fa fa-search"></i></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
</li>

    </ul>
</div>
<div class="main-inner">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <div class="post-header">
            <div class="post-author clearfix">
                
                <p><span class="label">作者</span>
                    <a href="" target="_blank">harvey</a>
                    <span title="最后编辑于2018-08-09">2018-08-09</span>
                </p>
                <p></p>
            </div>
            <h2 class="post-title">Spring-Cloud 微服务实战</h2>
            <div class="post-meta">
                本文总共2408个字 | 您是第<span id="busuanzi_value_page_pv"><i
                            class="fa fa-spinner fa-spin"></i></span>位看到它们的小伙伴
            </div>
        </div>
        <div class="post-content markdown-body">
            <p>说到微服务，相信大家一定不陌生，Duobbo、Spring Cloud 都是目前很流行的微服务框架，Spring Cloud 对于中小型互联网公司来说是一种福音，它利用 Spring Boot 的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等，使用 Spring Cloud 一站式解决方案能在从容应对业务发展的同时大大减少开发成本，但是在技术选型和实际生产应用中仍然会碰到很多的问题。所以结合我司<a href="http://www.vpgame.com/" target="_blank" rel="noopener">VPGAME</a>在交易、库存、消息、赛事、<a href="http://open.varena.com/" target="_blank" rel="noopener">Dota2 数据服务</a>等核心业务场景的实际落地经验，以及国内外一线互联网公司在微服务的开源实践，总结出一些 Spring Cloud 微服务实践和使用过程出现的问题，希望能够为大家解决一些疑惑。</p>
<ol>
<li>服务注册与发现</li>
</ol>
<ul>
<li>服务注册：<br>Spring Cloud 支持Consul、Zookeeper、Etcd、Euerka 等多种注册中心，这里主要讲一下 Zookeeper 和 Euerka 选择时的一些考虑。著名的CAP理论指出，一个分布式系统不可能同时满足C(一致性)、A(可用性)和P(分区容错性)，由于分区容错性在是分布式系统中必须要保证的，因此我们只能在A和C之间进行权衡。ZooKeeper基于CP，不保证高可用，如果 ZooKeeper 正在选主，或者 Zookeeper 集群中半数以上机器不可用，那么将无法获得数据。Eureka 基于AP，能保证高可用，即使所有机器都挂了，也能拿到本地缓存的数据。很显然在注册中心的场景，更关注的是服务高可用，但是我们最终选用了 Zookeeper 作为注册中心，主要有以下几点原因：</li>
</ul>
<p>a.我们自研的服务管理中心通过修改服务权重实现了服务热更新和合理负载等功能，需要保证配置信息的强一致性</p>
<p>b.在实际的生产过程中服务发现都是通过内网通信，网络问题和集群半数以上机器宕机的可能性非常小，当然我们也可以参考 Euerka 的本地缓存机制来提高其可用性</p>
<ul>
<li>服务发现：Ribbon是客户端软负载库，内部微服务直连可以直接走 Ribbon 客户端软负载，网关上也可以部署 Ribbon，我们在生产中主要是在在网关上通过 Ribbon 来实现软负载， 这一点就不再赘述。</li>
</ul>
<ol start="2">
<li>服务网关</li>
</ol>
<p>Zuul 网关在 Netflix 经过生产级验证，在纳入 Spring Cloud 体系之后，在社区中也有众多成功的应用,微服务基础架构中网关一块的首选,我们在实践过程中通过其实现了参数签名验证、用户身份认证、动态路由（支持Java 、PHP、Go等多语言服务）、服务灰度、服务限流等功能。需要注意的主要有以下几点：</p>
<p>a.线程数，Ribbon 总连接数、单个路由连接数、超时时间，Hystrix 熔断条件等核心参数的配置<br>b.Zuul 1.0 是同步阻塞架构，依赖多线程来支持吞吐量的增长，高并发情况下因为某个服务异常容易导致雪崩，因此需要结合 Hystrix 实现服务熔断和降级。但是 <a href="https://mp.weixin.qq.com/s?__biz=MzIwMzg1ODcwMw==&amp;mid=2247487846&amp;idx=1&amp;sn=0db93ba1f881783edf85871a2fe34730&amp;chksm=96c9a706a1be2e10e8c531f7f277b89247a0b3530af95a7fe1142223eacfbfd2e864bd6227d3&amp;mpshare=1&amp;scene=23&amp;srcid=0523ojuQsAJtCxbCnd1Putfr#rd" target="_blank" rel="noopener">Zuul 2.0</a> 用异步非阻塞架构可以更好的解决该问题，同时2.0版本还发布了许多新特性，需要在生产中实践验证。<br><img src="http://or2cbrqay.bkt.clouddn.com/api-gate%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg" alt="网关示意图"></p>
<ol start="3">
<li><p>配置中心：</p>
<p>在大型分布式系统架构中，各个服务之间的配置信息管理和同步问题很快就会凸显出来，我们在最初的架构中采用的是Zookeeper 作为配置中心，当服务数量不多且部署在同一个机房的情况下方便实用。但是当服务越来越多，配置也成倍的增加，更涉及到跨机房跨可用区甚至跨洋，配置无法可视化管理、跨机房调用、配置权限透明等问题急需解决。我们当时调研了Spring Cloud Config 和 Apollo 两个开源的配置信息框架，通过调研Spring Cloud Config的功能并不能完美的应对复杂的分布式场景，也不能进行可视化管理，而携程开源的 <a href="https://github.com/ctripcorp/apollo/wiki" target="_blank" rel="noopener">Apollo</a> 支持完善的管理界面，支持多环境，配置变更实时生效，权限和配置审计等多种生产级功能，更适合目前在生产环境中的直接使用。</p>
</li>
<li>服务链路监控</li>
</ol>
<p>在单体应用架构中，我们可以通过日志快速的进行问题分析和定位，但是在分布式微服务场景下很难简单的通过日志查看某一个请求经过网关然后调用了对应的哪些服务，以及相应的请求状态和时长，同时针对多语言和前后端分离我们在通信协议里规定一个请求从Web 和移动端发起需要在header头携带X-Request-ID 参数，同样在后续服务应用日志中都会要求添加该参数，这样每一个流入系统请求的都会有一个唯一标识，当出现问题很容易进行故障定位。当然Spring Cloud支持基于 Zipkin 的调用链监控，我们在生产中结合自研 trace 系统实现了服务的链路追踪，对于微服务场景下的问题排查有非常大的帮助：<br><img src="http://or2cbrqay.bkt.clouddn.com/v2-e952deddc1e11b4be0af3032fde24f5e_r.jpg" alt="链路追踪"></p>
<ol start="5">
<li><p>服务监控和告警</p>
<p>当整个微服务系统在线上能够稳定的运行，并不代表我们就可以高枕无忧了，恰恰相反随着服务数量的不断增加，排查问题变得越来越困难，能否第一时间处理和预警，对于每个服务的监控就显得尤为重要，在服务化初期，我们采用的自研monitior-service 、Influxdb 、 Grafana实现了第一个版本的监控和告警。<br><img src="http://or2cbrqay.bkt.clouddn.com/%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1%E9%80%BB%E8%BE%91%E5%9B%BE%20%282%29.png" alt="监控服务架构图V1"><br>每个客户端自行将监控数据通过monitor-service保存到 influxdb ，然后通过Grafana配置相应的监控面板和告警策略。随着业务的不断增长，监控粒度和指标以及告警策略的管理，也都越来越困难，为此我们进行了第二轮的监控系统升级，架构如图：<br><img src="http://or2cbrqay.bkt.clouddn.com/%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="监控服务架构图V2"><br>另外附上我们的整体微服务分层架构，有不足之处欢迎留言一起探讨。<br><img src="http://or2cbrqay.bkt.clouddn.com/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E5%88%86%E5%B1%82.jpg" alt="微服务分层架构图"><br>写在结尾，以上只是整个微服务架构体系中的一部分，在分布式微服务架构中分布式锁、分布式缓存、微服务的部署和持续集成等都是非常重要的，在此就没有一一进行列举。总之我们需要保持对新技术的渴望和追求，更应该结合公司的实际情况，选择最适合的技术栈和架构。</p>
</li>
</ol>

        </div>
        <!--<div class="post-tool">-->
            <!--<a class="btn-thumbs-up" href="javascript:void(0);" data-cid="52" title="95">-->
                <!--<i class="fa fa-thumbs-up" aria-hidden="true"></i> 打赏-->
            <!--</a>-->
        <!--</div>-->
        
        <div class="post-tags">标签：
            
            <a href="/tags/后端/">后端</a>
            
        </div>
        
    </article>
    
    
</div>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        </div><!-- end #main-->
    </div><!-- end #body -->
    <footer class="footer">
    <div class="footer-inner">
        <p>
            <a href="/about"  title="关于本站">关于本站</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <!-- 自定义链接 -->
            <!--<a href="/help" title="help" >帮助中心</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp-->
            <a href="http://www.vpgame.cn/" title="VPGAME">VPGAME</a>&nbsp;&nbsp<em>·</em>&nbsp;&nbsp
            <!--<a href="/app" title="App下载">App下载</a>-->
        </p>
        <p>
            本站点采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>，已建立<a href="/timeline" id="siteBuildingTime"></a>天<br/>
            ©2018 基于<a href="http://hexo.io" target="_blank">Hexo</a>搭建
            ，作者<a href="https://www.tangkunyin.com" target="_blank">vpinfra</a>
            <!--，Hosted by <a href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>-->
        </p>
        

    </div>
</footer>
<script src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
<script src="/js/InsightSearch.js"></script>
<script src="/js/SimpleCore.js"></script>

</div>
<div class="fixed-btn">
    <a class="btn-gotop" href="javascript:"> <i class="fa fa-angle-up"></i></a>
</div>
<script>
    $(function () {
        SimpleCore.init({
            buildingTime: '01/20/2018',
            current: $('.post-tags').length > 0 ? 'post' : 'archive',
            snsQRCode: '/images/sns-qrcode.png',
            donateImg: '/images/donate-qr.png',
        });
    });
</script>
</body>
</html>
