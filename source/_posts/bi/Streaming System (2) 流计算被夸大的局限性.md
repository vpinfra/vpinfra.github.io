id: 201903262308
title: Streaming System （2）流计算被夸大的局限性
date: 2019-03-26 23:08:45
categories: 大数据
tags: [大数据]
author: 赵明旭

-------------
本节将讨论流计算系统可以做什么以及不能做什么，重点是流计算可以做什么。我想要阐述的最重要的事情是一个设计良好的流计算系统拥有哪些能力。流计算系统一直以来被归为一个提供低延迟，不准确或投机结果的利基市场（即高度专门化的需求市场），经常和更加通用且常见的批处理系统一起协同使用，即Lambda架构。
Lambda架构基本思路是批和流计算系统同时运行，并且执行几乎完全一致的计算，流系统提供低延时，不准确的结果（因为流计算系统本身的局限性或者是使用了近似算法），一段时间后使用批计算系统对结果进行计算并修正。这个架构最初是由Twitter的Nathan Marz(Storm的创造者）提出的，这个架构确实很成功：流计算系统在正确性方面让人感到失望，而批计算系统则天生比较笨重，Lambda架构将二者整合，弥补了彼此的缺点。然而不幸的是，维护一个Lambda架构是一件非常麻烦的事情：您需要构建，提供和维护两个相互独立的组件，并且要以某种方式将两个组件所得到的结果合并。
作为一个花了数年时间致力于创建一个稳定，可靠的流引擎的人，我对Lambda架构并不是很认同。毫无疑问的说，我是Jay Kreps 提出的[质疑Lambda架构](https://www.oreilly.com/ideas/questioning-the-lambda-architecture)观点的支持者，它是第一个公开发声来质疑双系统架构执行的必要性。Kreps使用了一个数据可再次读取的系统例如Kafka解决了计算的重复性问题，并以此提出了Kappa体系结构。这意味着，对于数据计算而言，只需一套单独的管线以及为当前工作所构建的设计良好的系统架构，即可解决现有问题。
我认同这些理念，然而我觉得一个设计良好的流计算系统也可以提供严格可靠的批处理功能。模块化是一个有效的改变，而不应该去仅仅模仿现有的批处理系统。为此，Flink深谙此道，并构建了一个一切均基于流作为底层实现的系统，包括批模式也是。

* * *

**流和批计算效率的差异**
大多数人把流和批计算效率差异的原因归咎于流计算系统本身的局限性，而我认为真正的原因是大多数流计算系统所做设计时选择的结果。当下的批系统通过更多的捆绑操作和更高效的数据传输，竭尽全力的实现复杂的优化，使得使用有限的资源达到极高的吞吐量水平。
这些设计优良的高效方案同样也可以用在流计算上，通过统一的编程模型可以同时提供批和流两种处理模式，可以让用户在批的高效率和流的低延迟之间更灵活的选择。就像我们在谷歌对云数据所做的，我们使用两个完全独立的容器搭建两套独立的系统，并针对他们各自的特点做了优化。从长远的角度来看，我还是希望他们可以融合为一个系统，将二者的优点结合在一起，同时仍然保持选择适当效率的灵活性，但这在今天还是无法做到的。说实话，考虑到没有严格统一的数据模型的必要性，所以这点可能永远无法实现。

* * *

当流计算系统广泛并且成熟的使用，加上用于无界数据处理的框架越发健壮，Lambda架构终将成为历史。我相信现在就是实现这一目标的时候了，要实现这一目标，你只需要做到两件事：

-   正确性：
    
    正确性是和批处理可以较量的基础。正确性的核心，是持久化存储的一致性。流计算系统需要一种能够将状态进行持久化存储的检查点方法（相关内容可以查看[为什么本地状态是流处理的一个基本要素](https://www.oreilly.com/ideas/why-local-state-is-a-fundamental-primitive-in-stream-processing)），并且该方法必须设计的足够好，能保障集群在出故障后的容错性。当Spark在几年前首次公开在大数据领域时，他是第一个在黑暗的流处理领域实现强一致性的框架。幸运的是，在那之后，情况有了很大的改善，但是至今仍有很多流计算系统仍然试图在没用强一致性的情况下运行。
    
    重申一下，因为这点非常重要：exactly-once(恰好一次）需要非常强的一致性，这是正确性的必备条件，也是任何有机会达到甚至超过批计算系统处理能力的系统的需求。除非你真的不在乎结果，否则我恳请你避开任何不能提供强一致性状态的流计算系统。批计算系统因为在计算时所有数据已经确定了所以不需要您提前验证它们是否能够生成正确的答案；所以不要把你的时间浪费在不能满足同样标准的流计算系统上。
    
    关于一致性相关的论文可以查看[the MillWheel](http://static.googleusercontent.com/media/research.google.com/en//pubs/archive/41378.pdf?spm=a2c4e.11153940.blogcont674448.14.5c1d2842ZOenIT&file=41378.pdf),[Flink snapshot](https://arxiv.org/pdf/1506.08603.pdf?spm=a2c4e.11153940.blogcont674448.13.5c1d2842ZOenIT&file=1506.08603.pdf),
    
-   时间处理工具（Tools for Reasoning about Time）
    
    时间处理工具是超越批处理的方法。良好的时间处理工具对于处理无界、无序、时间轴混乱的倾斜数据是至关重要的。越来越多的现代数据集正表现出这一特征，而现有的批计算系统（以及众多的流计算系统）都缺少必要的工具来对应这一问题所带来的困难。下一个章节我们将来详细的解释和关注这些内容。